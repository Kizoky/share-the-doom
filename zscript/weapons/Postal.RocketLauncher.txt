class PostRLauncher : PostalWeapon
{
	bool SeekingMissile;
	int DistanceFire;
	
	Default
	{
		//$Category STD Weapons
		//$Title "Missile Launcher"
		//$Sprite PICKA0
		Weapon.Kickback 100;
		Weapon.SelectionOrder 1300;
		Weapon.AmmoUse 1;
		Weapon.AmmoGive 8;
		Weapon.AmmoType "Clip";
		+WEAPON.NOAUTOFIRE;
		Obituary "$PSTL_OB_ROCKET";
		Tag "$PSTL_WP_ROCKET";
		Inventory.PickupMessage "$PSTL_PP_ROCKET";
	}
	States
	{
	Ready:
		RLID ABCDEFGHIJKLMNOP 7 A_WeaponReady;
		Goto Ready;
	Deselect:
		TNT1 AAAAAAAAAAAAAAA 0 A_Lower;
		RLDE ABCDEFGHIJ 2;
		Loop;
	Select:
		TNT1 AAAAAAAAAAAAAAA 0 A_Raise;
		TNT1 A 0 A_WeaponOffset(0,32); // Fix "bump" when weapon is selected
		TNT1 A 0 A_PlaySound("weaponselect4", 7 | 4096);
		RLSE ABCDEFGHIJKLMNOPQRST 2 A_WeaponReady;
		Loop;
	Fire:
		RLHA A 0 A_PlaySound("weapons/fueling", 7 | 4096);
		RLHA ABCDEFGHIJKLMNOPQRSTUVWXYZ 3
		{
			if (!(player.cmd.buttons & BT_ATTACK))
			{
				invoker.SeekingMissile = false;
				return ResolveState ("FireEnd");
			}
			else
				invoker.DistanceFire += 2;
			
			return ResolveState (null);
		}
		RLH2 ABCDEFGHIJ 3
		{
			if (!(player.cmd.buttons & BT_ATTACK))
			{
				invoker.SeekingMissile = false;
				return ResolveState ("FireEnd");
			}
			else
				invoker.DistanceFire += 2;
			
			return ResolveState (null);
		}
		RLFI A 0 A_PlaySound("weapons/seeker", 7 | 4096);
		Goto FireLoop;
	FireLoop:
		RLFI ABCDEFGHIJKLM 3
		{
			if (!(player.cmd.buttons & BT_ATTACK))
			{
				invoker.SeekingMissile = true;
				return ResolveState ("FireEnd");
			}
			return ResolveState (null);
		}
		Loop;
	FireEnd:
		RLFA A 0
		{
			if (invoker.SeekingMissile == false)
			{
				A_FireProjectile("PostalRocket");
				invoker.DistanceFire = 0;
			}
			else
				A_FireProjectile("SeekerRocket");
		
		}
		RLFA ABCDEFGHIJKLMN 3;
		Goto Ready;
	Spawn:
		TNT1 A 0;
		PICK A -1;
		Stop;
	}
}

//Unused
extend class PostRLauncher
{
	action void A_SeekerMode()
	{
		if (target == null) return;
		AddZ(16);
		Actor missile = SpawnMissile(target, "SeekerRocket");
		AddZ(-16);
		if (missile != null)
		{
			missile.SetOrigin(missile.Vec3Offset(missile.Vel.X, missile.Vel.Y, 0.), false);
			missile.tracer = target;
		}
	}
}

class PostalRocket : Actor
{
	Default
	{
		Radius 11;
		Height 8;
		Speed 10;
		Damage 20;
		Projectile;
		+RANDOMIZE
		+DEHEXPLOSION
		+ROCKETTRAIL
		+ZDOOMTRANS
		SeeSound "weapons/rocklf";
		DeathSound "weapons/rocklx";
		Obituary "$OB_MPROCKET";
	}
	States
	{
	Spawn:
		MISL A 1 Bright;
		Loop;
	Death:
		MISL B 8 Bright A_Explode;
		MISL C 6 Bright;
		MISL D 4 Bright;
		Stop;
	}
}

class SeekerRocket : Actor
{
	Default
	{
		Radius 11;
		Height 8;
		Speed 10;
		Damage 20;
		Projectile;
		+RANDOMIZE
		+DEHEXPLOSION
		+ROCKETTRAIL
		+ZDOOMTRANS
		+SEEKERMISSILE
		BounceType "Hexen";
		BounceCount 5;
		BounceSound "weapons/bounce";
		SeeSound "weapons/rocklf";
		DeathSound "weapons/rocklx";
		Obituary "$OB_MPROCKET";
	}
	States
	{
	Spawn:
		TNT1 A 0 A_SeekerMissile(0,45); //can turn 45 angle at max
		MISL A 1 Bright A_Tracer;
		Loop;
	Death:
		MISL B 8 Bright A_Explode;
		MISL C 6 Bright;
		MISL D 4 Bright;
		Stop;
	}
}